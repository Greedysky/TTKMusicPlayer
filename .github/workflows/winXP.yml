# Author: Greedysky <greedysky@163.com>

name: winXP

on: workflow_call

env:
  TTK_MODULE: TTKMusicPlayer
  TTK_VERSTION: 4.2.0.0

jobs:
  build:
    name: Build on Qt4
    strategy:
      matrix:
        os: [windows-2022]

    env:
      QT_VERSION: 4.8.7
      QT_ROOT_DIR: D:/a/TTKMusicPlayer/Qt/4.8.7
      QT_BIN_DIR: D:/a/TTKMusicPlayer/Qt/4.8.7/bin
      QT_LIB_DIR: D:/a/TTKMusicPlayer/Qt/4.8.7/lib
      MINGW_PATH: D:/a/TTKMusicPlayer/mingw/bin
      WIN_QMMP_DEPS_PATH: D:/a/TTKMusicPlayer/TTKMusicPlayer/extra/gcc
      UNIX_QMMP_DEPS_PATH: /d/a/TTKMusicPlayer/TTKMusicPlayer/extra/gcc

    runs-on: ${{matrix.os}}
    steps:
      - name: Clone qmmp module
        run: git clone -b plugins https://github.com/Greedysky/${{env.TTK_MODULE}}.git
        working-directory: ${{runner.workspace}}

      - name: Install Qt
        run: |
          curl -L https://github.com/Greedysky/Resource/releases/download/1.0.0.0/Qt4.7z -o Qt.7z
          7z x Qt.7z -oQt
          "[Paths]`nPrefix = ${{env.QT_ROOT_DIR}}" > ${{env.QT_BIN_DIR}}/qt.conf
          echo "${{env.QT_BIN_DIR}};" >> $env:GITHUB_PATH
        working-directory: ${{runner.workspace}}

      - name: Install MinGW492_32
        run: |
          curl -L https://github.com/Greedysky/Resource/releases/download/1.0.0.0/mingw492_32.7z -o mingw.7z
          7z x mingw.7z -omingw
          # remove default installed mingw64
          mv C:\mingw64 C:\mingw64_useless
          # set environment variable
          echo "${{env.MINGW_PATH}};" >> $env:GITHUB_PATH
        working-directory: ${{runner.workspace}}

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw32
          update: true
          install: >-
            p7zip
            libtool
            make
            texinfo
            autoconf
            automake
            pkg-config

      - name: Create thirdParty dir
        shell: bash
        run: mkdir -p ${{env.UNIX_QMMP_DEPS_PATH}}
        working-directory: ${{runner.workspace}}

      - name: Install thirdParty dependencies
        run: |
          curl -L https://github.com/Greedysky/TTKMusicPlayer/releases/download/continuous-build/thirdParty-libraries-win-mingw492-x86.7z -o thirdParty-libraries.7z
          7z x thirdParty-libraries.7z
        working-directory: ${{github.workspace}}/extra

      - name: Build qmmp project
        run: |
          qmake -v
          qmake -spec ${{env.QT_ROOT_DIR}}/mkspecs/win32-g++ "CONFIG+=release" .
          mingw32-make -j2
        working-directory: ${{github.workspace}}/qmmp

      - name: Build qmmp package
        run: |
          # add dependency for theme
          curl -L https://github.com/Greedysky/Resource/releases/download/1.0.0.0/theme.7z -o theme.7z
          7z x theme.7z
          mv GTheme bin/${{env.TTK_VERSTION}}
          # add dependency for openssl
          curl -L https://github.com/Greedysky/Resource/releases/download/1.0.0.0/openssl.7z -o openssl.7z
          7z x openssl.7z
          cp win32.old/*.dll bin/${{env.TTK_VERSTION}}
          # add dependency for global plugins
          curl -L https://github.com/Greedysky/${{env.TTK_MODULE}}/releases/download/continuous-build/qmmp-gplugins-win.7z -o qmmp-gplugins-win.7z
          7z x qmmp-gplugins-win.7z
          mv GPlugins_x86 bin/${{env.TTK_VERSTION}}/GPlugins
          # remove useless qmmp demo bin
          rm bin/${{env.TTK_VERSTION}}/demo.exe
          # copy ffmpeg libraries
          cp ${{env.WIN_QMMP_DEPS_PATH}}/libffmpeg/bin/avcodec-57.dll bin/${{env.TTK_VERSTION}}
          cp ${{env.WIN_QMMP_DEPS_PATH}}/libffmpeg/bin/avformat-57.dll bin/${{env.TTK_VERSTION}}
          cp ${{env.WIN_QMMP_DEPS_PATH}}/libffmpeg/bin/avutil-55.dll bin/${{env.TTK_VERSTION}}
          cp ${{env.WIN_QMMP_DEPS_PATH}}/libffmpeg/bin/swresample-2.dll bin/${{env.TTK_VERSTION}}
          # copy sunvox libraries
          cp ${{env.WIN_QMMP_DEPS_PATH}}/libsunvox/sunvox.dll bin/${{env.TTK_VERSTION}}
          # copy optimfrog libraries
          cp ${{env.WIN_QMMP_DEPS_PATH}}/liboptimfrog/bin/libOptimFROG.dll bin/${{env.TTK_VERSTION}}
          mv bin ${{runner.workspace}}/qmmp
          # add portable binary package
          7z a qmmp-qt4-win-mingw492-x86.7z ${{runner.workspace}}/qmmp/${{env.TTK_VERSTION}}
        working-directory: ${{github.workspace}}/qmmp

      - name: Archive artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: continuous-build
          token: ${{secrets.GITHUB_TOKEN}}
          generate_release_notes: false
          files: ${{github.workspace}}/qmmp/qmmp-qt4-win-mingw492-x86.7z

      - name: Clean up qmmp build
        shell: bash
        run: |
          rm -rf "${{github.workspace}}"
          rm -rf "${{runner.workspace}}/thirdParty"
        working-directory: ${{runner.workspace}}

      - name: Clone ttk music player module
        run: git clone https://github.com/Greedysky/${{env.TTK_MODULE}}.git
        working-directory: ${{runner.workspace}}

      - name: Create build dir
        shell: bash
        run: mkdir build
        working-directory: ${{runner.workspace}}

      - name: Build ttk music player project
        run: |
          cmake --version
          cmake ${{github.workspace}} -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${{runner.workspace}}/install -DCMAKE_PREFIX_PATH=${{env.QT_ROOT_DIR}} -DTTK_QT_VERSION=4 -DTTK_QMMP_LIBRARY=${{runner.workspace}}/qmmp/${{env.TTK_VERSTION}}/libTTKqmmp.a
          mingw32-make -j2 && mingw32-make install
        working-directory: ${{runner.workspace}}/build

      - name: Build ttk music player package
        run: |
          # add dependency for qmmp library
          cp ${{runner.workspace}}/qmmp/${{env.TTK_VERSTION}} ${{env.TTK_MODULE}} -Recurse -Container -Force
          # add dependency libraries and so on
          cp ${{env.QT_ROOT_DIR}}/plugins/bearer ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}} -Recurse -Container -Force
          cp ${{env.QT_ROOT_DIR}}/plugins/iconengines ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}} -Recurse -Container -Force
          cp ${{env.QT_ROOT_DIR}}/plugins/imageformats ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}} -Recurse -Container -Force
          cp ${{env.QT_BIN_DIR}}/QtCore4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtGui4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtMultimedia4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtNetwork4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtOpenGL4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtSvg4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.QT_BIN_DIR}}/QtXml4.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.MINGW_PATH}}/libgcc_s_dw2-1.dll ${{env.TTK_MODULE}}
          cp ${{env.MINGW_PATH}}/libstdc++-6.dll ${{env.TTK_MODULE}}
          cp ${{env.MINGW_PATH}}/libwinpthread-1.dll ${{env.TTK_MODULE}}
          cp ${{env.MINGW_PATH}}/libgcc_s_dw2-1.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.MINGW_PATH}}/libstdc++-6.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          cp ${{env.MINGW_PATH}}/libwinpthread-1.dll ${{env.TTK_MODULE}}/${{env.TTK_VERSTION}}
          # remove useless library dependency
          ls -Filter "*.a" -Recurse | Remove-Item -Force
        working-directory: ${{runner.workspace}}/install

      - name: Add output path for install package
        shell: bash
        run: |
          sed -i "11d" "${{github.workspace}}/TTKUtils/ttk.iss"
          sed -i "11i#define OutputPath \"${{env.QT_ROOT_DIR}}/../../install/\"" "${{github.workspace}}/TTKUtils/ttk.iss"
        working-directory: ${{runner.workspace}}

      - name: Install Inno Setup 6
        run: |
          curl -L https://github.com/Greedysky/Resource/releases/download/1.0.0.0/InnoSetup.7z -o InnoSetup.7z
          7z x InnoSetup.7z -oInnoSetup
        working-directory: ${{runner.workspace}}

      - name: Build ttk music player install package
        run: |
          # reg add "HKCU\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers" /v "${{runner.workspace}}/InnoSetup/iscc.exe" /t REG_SZ /d "WIN7RTM RUNASADMIN" /f
          ${{runner.workspace}}/InnoSetup/iscc.exe ${{github.workspace}}/TTKUtils/ttk.iss
          mv v${{env.TTK_VERSTION}}.exe ${{env.TTK_MODULE}}-${{env.TTK_VERSTION}}-winXP-x86.exe
        working-directory: ${{runner.workspace}}/install

      - name: Build ttk music player portable package
        run: |
          # add portable configuration
          cp ${{github.workspace}}/TTKUtils/ttk_portable ${{env.TTK_MODULE}}
          "便携模式运行 TTKMusicPlayer.exe`r`n删除 ttk_portable 禁用便携模式" > ${{env.TTK_MODULE}}/说明.txt
          # add portable binary package
          7z a ${{env.TTK_MODULE}}-${{env.TTK_VERSTION}}-winXP-x86.7z ${{env.TTK_MODULE}}
        working-directory: ${{runner.workspace}}/install

      - name: Archive artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: continuous-build
          token: ${{secrets.GITHUB_TOKEN}}
          generate_release_notes: false
          files: |
            ${{runner.workspace}}/install/${{env.TTK_MODULE}}-${{env.TTK_VERSTION}}-winXP-x86.7z
            ${{runner.workspace}}/install/${{env.TTK_MODULE}}-${{env.TTK_VERSTION}}-winXP-x86.exe
